---
title: Promise总结
date: 2018-03-27
categories: 
- FE
- es6
tags:
- es6
- Promise
---


前几天去头条面试，用promise封装fetch加入超时处理的问题上没答出来，es6了解一些但是用的不多，所以很多细节都没仔细考虑，因此这篇就总结一下promise吧~~~~

# Promise

异步编程的解决方案，简单说就是一个容器，里面保存着某个未来才会结束的事件（通常是一个异步操作）的结果

promise 对象代表一个异步操作。

## 状态

promise 有三种状态：

1. pending
2. resolved
3. rejected


## 特点
1. 对象的状态不受外部影响  只有异步操作的结果，可以决定当前是哪一种状态，任何其他操作都无法改变这个状态。resolve == pending ->resolved/reject == pending->rejected

2. 一旦状态改变，就不会再变，任何时候都可以得到这个结果


## 用法

Promise 构造函数 接受一个函数作为参数，该函数的；两个参数分别是resolve 和reject

Promise实例生成以后，可以用then方法分别指定Resolved状态和Reject状态的回调函数。

### then方法可以接受两个回调函数作为参数。

第一个回调函数是Promise对象的状态变为Resolved时调用，

第二个回调函数是Promise对象的状态变为Reject时调用。

其中，第二个函数是可选的，不一定要提供。这两个函数都接受Promise对象传出的值作为参数。

```javascript

function timeout = (ms)=>{
    return new Promise((resolve,reject) => {
        setTimeout(resolve,ms);
    })
}
timeout(3000).then((value)=>{
    console.log(value);
})
 

//用promise封装一个ajax函数

var _ajax = (url) =>{
    var promise = new Promise((resolve,reject) =>{
        var request = new XMLHttpRequest();
        request.open('GET',url);
        request.onreadystatechange = ()=>{
            if(this.readystate != 4){
                return;
            }else{
                if(this.status == 200){
                    resolve(this.response);
                }else{
                    reject(new Error(this.statustext));
                }
            }
        }
        client.responseType = 'json';
        client.setRequestHeader('Accept','application/json');
        client.send();
    })
    return promise;
}
```

## Promise.prototype.then()

### 作用

为promise实例添加状态改变时的回调函数

### 返回
then方法返回的是一个新的promise实例

第一个回调函数完成以后，会将返回结果作为参数，传入第二个回调函数。

## Promise.all()

### 作用

Promise.all方法用于将多个Promise实例，包装成一个新的Promise实例。

### 使用

Promise.all方法接受一个数组作为参数，p1、p2、p3都是Promise对象的实例，如果不是，就会先调用下面讲到的Promise.resolve方法，将参数转为Promise实例，再进一步处理。（Promise.all方法的参数可以不是数组，但必须具有Iterator接口，且返回的每个成员都是Promise实例。）

p的状态由p1、p2、p3决定，分成两种情况。

（1）只有p1、p2、p3的状态都变成fulfilled，p的状态才会变成fulfilled，此时p1、p2、p3的返回值组成一个数组，传递给p的回调函数。

（2）只要p1、p2、p3之中有一个被rejected，p的状态就变成rejected，此时第一个被reject的实例的返回值，会传递给p的回调函数。


## Promise.race()

### 使用

只要p1、p2、p3之中有一个实例率先改变状态，p的状态就跟着改变。那个率先改变的Promise实例的返回值，就传递给p的回调函数。

Promise.race方法的参数与Promise.all方法一样，如果不是Promise实例，就会先调用下面讲到的Promise.resolve方法，将参数转为Promise实例，再进一步处理。

下面是一个例子，如果指定时间内没有获得结果，就将Promise的状态变为reject，否则变为resolve。

fetch加入超时处理

```javascript
var p = Promise.race([fetch(url),new Promise((resolve,reject) =>{
    setTimeout(()=>{
        reject(new Error('超时'));
    },3000);
})]);
p.then(response => console.log(response));
p.catch(error => console.log(error));
```

