---
title: 浏览器缓存
date: 2018-03-22
categories: 
- 浏览器
tags:
- FE
- 浏览器
---

# 浏览器缓存

浏览器对于请求资源，有以下缓存策略：

**存储策略**：收到响应后应用

**过期策略**：发送请求前

**协商策略**：发送请求前 （http再验证）

## http header中与缓存相关的key


key | description | 存储策略 | 过期策略   | 协商策略
------ | --------- | :-------: | :------: | :-------: 
 Cache-Control| 指定缓存机制 | 是 | 是 | 否 
Pragma | http1.0字段，指定缓存机制 | 是 | 否 | 否
Expires | 指定缓存的过期时间 | 否 | 是 | 否
Last-Modified|资源最后一次的修改时间 | 否 | 否| 是
ETag | 唯一标识请求资源的字符串 | 否 | 否 | 是




## 缓存协商策略用于http再验证，缓存资源是否有效，相关key


key | description 
------ | --------- 
If-Modified-Since | 缓存校验字段，值为资源最后一次的修改时间，即上次收到的Last-Modified
If-Unmodified-Since | 同上，处理方式与之相反
If-Match | 缓存校验字段，值为唯一标识请求资源的字符串，即上次收到的ETag
If-None-Match | 同上，处理方式与之相反

------


## Cache-Control

优先级最高，可以覆盖其他字段的设置，可以同时在请求头和响应头中设置

cache-directive | description
| ------ | ------
public  | 资源将被客户端和代理服务器缓存
private | 资源仅被客户端缓存，代理服务器不缓存
no-store| 请求和响应都不缓存
no-cache | 相当于max-age:0,缓存立刻过期，下次访问时强制验证资源有效性
max-age | 缓存资源，但在指定时间（s）后缓存过期
s-maxage | 只在代理服务器上有效


## Expires

即到期时间, 以服务器时间为参考系, 其优先级比 Cache-Control:max-age 低, 两者同时出现在响应头时, Expires将被后者覆盖. 如果Expires, Cache-Control: max-age, 或 Cache-Control:s-maxage 都没有在响应头中出现, 并且也没有其它缓存的设置, 那么浏览器默认会采用一个启发式的算法, 通常会取响应头的Date_value - Last-Modified_value值的10%作为缓存时间.

## 强缓存

一旦资源命中强缓存, 浏览器便不会向服务器发送请求, 而是直接读取缓存. Chrome下的现象是 200 OK (from disk cache) 或者 200 OK (from memory cache)

## 协商缓存

缓存过期后, 继续请求该资源, 对于现代浏览器, 拥有如下两种做法:

根据上次响应中的ETag_value, 自动往request header中添加If-None-Match字段. 服务器收到请求后, 拿If-None-Match字段的值与资源的ETag值进行比较, 若相同, 则命中协商缓存, 返回304响应.
根据上次响应中的Last-Modified_value, 自动往request header中添加If-Modified-Since字段. 服务器收到请求后, 拿If-Modified-Since字段的值与资源的Last-Modified值进行比较, 若相同, 则命中协商缓存, 返回304响应.
以上, ETag优先级比Last-Modified高, 同时存在时, 前者覆盖后者. 下面通过实例来理解下强缓存和协商缓存.

如下忽略首次访问, 第二次通过 If-Modified-Since 命中了304协商缓存.


## 让浏览器不缓存资源

实际上, 工作中很多场景都需要避免浏览器缓存, 除了浏览器隐私模式, 请求时想要禁用缓存, 还可以设置请求头: Cache-Control: no-cache, no-store, must-revalidate。



# DNS缓存

按距离
浏览器缓存-->系统缓存-->路由器缓存-->IPS服务器缓存-->根域名服务器缓存-->顶级域名服务器缓存-->主域名服务器缓存


## DNS负载均衡（DNS重定向）

应用：CDN技术 

DNS服务器会返回一个跟用户最接近的点的IP地址给用户，CDN节点的服务器负责响应用户的请求，提供所需的内容。



### 如何尽快的加载资源？

能不从网络中加载的资源就不从网络中加载，当我们合理使用缓存，将资源放在浏览器端，这是最快的方式。如果资源必须从网络中加载，则要考虑缩短连接时间，即DNS优化部分;减少响应内容大小，即对内容进行压缩。另一方面，如果加载的资源数比较少的话，也可以快速的响应用户。

当资源到达浏览器之后，浏览器开始进行解析渲染，浏览器中最耗时的部分就是reflow，所以围绕这一部分就是考虑如何减少reflow的次数。


1.CDN加速是对网站所在服务器加速，还是对其域名加速？

CDN是只对网站的某一个具体的域名加速。如果同一个网站有多个域名，则访客访问加入CDN的域名获得加速效果，访问未加入CDN的域名，或者直接访问IP地址，则无法获得CDN效果。